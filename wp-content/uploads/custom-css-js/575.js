/******* Do not edit this file *******
Simple Custom CSS and JS - by Silkypress.com
Saved: Aug 20 2020 | 07:45:36 */
/* Default comment here */ 

const _FORM = document.getElementById('wp_date_select_form');

var MONTH_SELECT;
var DATE_SELECT;

var MONTH_DEFAULT;
var DATE_DEFAULT;

var date_data;

setUp();

if (localStorage.selected_pandemicYear_date) { 
	MONTH_SELECT = _FORM.getElementsByTagName("select")[0];
	DATE_SELECT = _FORM.getElementsByTagName("select")[1];

	// parse stored data
	let past_month = localStorage.selected_pandemicYear_date.split(',')[0];
	let past_day = localStorage.selected_pandemicYear_date.split(',')[1];

	// get the selected index
	var index=0;
	for (var i=0;i<MONTH_SELECT.options.length;i++) {
		if (MONTH_SELECT.options[i].text == past_month) {
			index = i;
		}
	}

	MONTH_SELECT.selectedIndex = index;
	populateDates();

	// get the selected index
	index=0;
	for (var i=0;i<DATE_SELECT.options.length;i++) {
		if (DATE_SELECT.options[i].text == past_day) {
			index = i;
		}
	}

	DATE_SELECT.selectedIndex = index;
	linkButton();
}

function setUp() {
	// this prevents the setup script from running on pages it does not need to be run on
	if (_FORM == null) return;

	MONTH_SELECT = _FORM.getElementsByTagName("select")[0];
	DATE_SELECT = _FORM.getElementsByTagName("select")[1];

	MONTH_SELECT.addEventListener("change",populateDates);
	DATE_SELECT.addEventListener("change",linkButton);

	MONTH_DEFAULT = "- MONTH -";
	DATE_DEFAULT = "- DATE -";

	// this needs to be imported from somewhere
	date_data = {};

	date_data[MONTH_DEFAULT] = [];
	date_data["January"] = [ 1, 10, 14, 22, 24, 27, 29, 30, 31 ];
	date_data["February"] = [ 2 ];

	populateMonths();
	populateDates(); // populateDates now calls linkButton
}

function populateMonths() {
	// get the month select element
	// clear months and get ready for the data
	MONTH_SELECT.innerHTML = "";

	// adds every key from the object to the option list, in this case months
	Object.keys(date_data).forEach(value => addOption(value,MONTH_SELECT));
}

function populateDates() {
	// get the select elements
	// get chosen month
	var month_value = MONTH_SELECT.options[MONTH_SELECT.selectedIndex].text;
	
	// clear old date options
	DATE_SELECT.innerHTML = `<option value='${DATE_DEFAULT}'>${DATE_DEFAULT}</option>`;
	
	// populate the dates
	date_data[month_value].forEach(value => addOption(value,DATE_SELECT));

	linkButton();
}

// Adds an option element with the specified option to the document element
function addOption(option, doc_element) {
	doc_element.innerHTML += `<option value='${option}'>${option}</option>`;
}

function linkButton() {
	// get select elements
	// get selected values
	var month_value = MONTH_SELECT.options[MONTH_SELECT.selectedIndex].text;
	var date_value = DATE_SELECT.options[DATE_SELECT.selectedIndex].text;
	
	// get button element
	var button = document.getElementById('wp_date_submit');
	
	// build and link url
	var newUrl = ('0' + (MONTH_SELECT.selectedIndex)).slice(-2) +'-'+ ('0'+date_value).slice(-2);
	
	// this makes the anchor tag unclickable when there is an invalid date
	if (month_value == MONTH_DEFAULT || date_value == DATE_DEFAULT) {
		button.onclick = function(event) {
			// prevents the going to other page
			event.preventDefault();

			//alerts the user their date is invalid
			alert("Invalid Date");
		};
	}
	else {
		// undoes the above
		button.onclick = function(event) {
			// prevents the going to other page
			event.preventDefault();

			// Create a save of what is currently selected in the browser
			localStorage.selected_pandemicYear_date = month_value+","+date_value;

			// redirects to the proper page
			location.href=newUrl;
		};
	}
}

/**
 * Currently this function is weighted so that months are equal, meaning
 * for months that have fewer dates, their dates get chosen more frequently.
 */
function randomDate() {
	// get random month
	var keys = Object.keys(date_data);
	//keys.length -1 paired with the +1 to Math.floor() removes the MONTH option
	var randomKeyIndex = Math.floor(Math.random()* (keys.length-1) ) +1;
	var randomKey = keys[randomKeyIndex];

	// get random date
	var randomDateIndex = Math.floor(Math.random()*date_data[randomKey].length);
	var randomDate = date_data[randomKey][randomDateIndex];

	// create new url
	var newUrl = ('0' + (randomKeyIndex)).slice(-2) +'-'+ ('0'+randomDate).slice(-2);

	// get select elements
	// set their selected index
	MONTH_SELECT.selectedIndex = randomKeyIndex;
	populateDates(); // update date options
	DATE_SELECT.selectedIndex = randomDateIndex+1; // +1 to account for DATE
	linkButton();
}

function fullyRandomDate() {
	// get select elements
	// count all options
	var keys = Object.keys(date_data);
	var total_dates = 0;

	var i,j;
	for (i=0;i<keys.length;i++)
		total_dates += date_data[keys[i]].length;

	// choses a random date from all options
	var randomDateIndex = Math.floor(Math.random()*total_dates);
	
	for (i=0;i<keys.length;i++) {
		for (j=0;j<date_data[keys[i]].length && randomDateIndex > 0;j++,randomDateIndex--);
		
		// handles edge cases when the date is the first of the month
		if (j == date_data[keys[i]].length && randomDateIndex == 0) {
			j=0,i++;
		}
		if (randomDateIndex < 1) {
			MONTH_SELECT.selectedIndex = i;
			populateDates(); // update date options
			DATE_SELECT.selectedIndex = j+1; // +1 to account for DATE
			linkButton();
			// go to random link
			// window.location.href = newUrl;
			return;
		}
	}
}
